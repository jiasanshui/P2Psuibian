<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>员工列表</title>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../css/elementui.css">
    <script type="text/javascript" src="../js/vue.js"></script>
    <script type="text/javascript" src="../js/axios.min.js"></script>
    <script type="text/javascript" src="../js/elementui.js"></script>
    <!-- 引入样式 -->
    <link rel="stylesheet" href="../css/elementui.css">
    <!-- 引入组件库 -->
    <script src="../js/elementui.js"></script>

</head>
<body>
<div id="app">
    <h2>{{ message }}</h2>
</div>

<div id="tableView">
    <!--列表顶部搜索和工具条-->
    <el-row>
        <el-form :inline="true" :model="searchForm" class="demo-form-inline">
            <el-form-item label="员工编号">
                <el-input v-model="searchForm.id" placeholder="员工编号"></el-input>
            </el-form-item>
            <el-form-item label="名称">
                <el-input v-model="searchForm.name" placeholder="名称"></el-input>
            </el-form-item>
            <el-form-item label="部门">
                <template>
                    <el-select v-model="searchForm.deptId" placeholder="请选择">
                        <el-option
                                v-for="item in option"
                                :key="item.DEPTID"
                                :label="item.DNAME"
                                :value="item.DEPTID">
                        </el-option>
                    </el-select>
                </template>
            </el-form-item>
            <el-form-item label="状态">
                <template>
                    <el-select v-model="searchForm.State" placeholder="请选择">
                        <el-option
                                v-for="item in options"
                                :key="item.EID"
                                :label="item.STATES"
                                :value="item.EID">
                        </el-option>
                    </el-select>
                </template>
            </el-form-item>
            <el-form-item>
                <el-button type="primary" icon="search" @click="searchClick">查询</el-button>
                <el-button type="success" icon="plus" @click="addClick">新增</el-button>
                <el-button type="success" icon="plus" @click="toFlush">刷新</el-button>
            </el-form-item>
        </el-form>
    </el-row>
    <!--列表-->
    <el-row>
        <el-table
                :data="tableData"
                v-loading.body="loading"
                border
                @selection-change="selectionChange"
                style="width: 100%">
            <el-table-column
                    type="selection"
                    width="55">
            </el-table-column>
            <el-table-column
                    prop="EMPNO"
                    label="员工编号"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="ENAME"
                    label="姓名"
                    width="100">
            </el-table-column>
            <el-table-column
                    prop="IDCARD"
                    label="身份证号"
                    width="200">
            </el-table-column>
            <el-table-column
                    prop="PHONE"
                    label="电话"
                    width="150">
            </el-table-column>
            <el-table-column
                    prop="ADDRESS"
                    label="地址"
                    width="300">
            </el-table-column>
            <el-table-column
                    prop="RUZHITIME"
                    label="入职日期"
                    width="200">
            </el-table-column>
            <el-table-column
                    prop="STATES"
                    label="状态"
                    width="80">
            </el-table-column>
            <el-table-column
                    prop="DNAME"
                    label="所在部门"
                    width="110">
            </el-table-column>
            <el-table-column
                    prop="COMM"
                    label="奖金"
                    width="90">
            </el-table-column>
            <el-table-column
                    prop="SAL"
                    label="薪水"
                    width="90">
            </el-table-column>
            <el-table-column
                    label="操作">
                <template scope="scope">
                    <el-button :plain="true" type="success" size="small" icon="edit" @click="editClick(scope.row)">编辑</el-button>
                    <el-button :plain="true" type="danger" size="small" icon="delete" @click="deleteClick(scope.row)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>
    </el-row>

    <!--列表底部工具条和分页符-->
    <el-row style="margin-top: 20px" type="flex" justify="end">
        <el-col :span="6" >
            <el-button :plain="true" type="danger" size="small" icon="delete" @click="removeSelection">删除所选</el-button>
        </el-col>
        <el-col :span="18" >
            <el-pagination
                    style="float: right"
                    @size-change="pageSizeChange"
                    @current-change="currentPageChange"
                    :current-page="currentPage"
                    :page-sizes="[5, 10, 20, 30, 50]"
                    :page-size="pageSize"
                    layout="total, sizes, prev, pager, next, jumper"
                    :total="total">
            </el-pagination>
        </el-col>
    </el-row>

    <!----------------------------------编辑界面---------------------------------------------------------------------->
    <el-dialog title="编辑" :visible.sync="editFormVisible" :close-on-click-modal="false">
        <el-form :model="editForm" label-width="80px" :rules="editFormRules" ref="editForm">
            <el-form-item label="员工编号" prop="EMPNO">
                <el-input v-model="editForm.EMPNO" auto-complete="off"></el-input>
            </el-form-item>
            <el-form-item label="姓名" prop="ENAME" >
                <el-input v-model="editForm.ENAME" auto-complete="off"></el-input>
            </el-form-item>
            <el-form-item label="身份证号" prop="IDCARD">
                <el-input v-model="editForm.IDCARD" auto-complete="off"></el-input>
            </el-form-item>
            <el-form-item label="电话号码" prop="PHONE">
                <el-input v-model="editForm.PHONE" auto-complete="off"></el-input>
            </el-form-item>
            <el-form-item label="地址" prop="ADDRESS">
                    <el-select v-model="editForm.sheng" placeholder="请选择省份" @change="choseProvince">
                            <el-option
                                    v-for="item in province"
                                    :key="item.id"
                                    :label="item.value"
                                    :value="item.id">
                            </el-option>
                    </el-select>
                    <el-select v-model="editForm.shi" placeholder="请选择市" @change="choseCity">
                        <el-option
                                v-for="item in shi1"
                                :key="item.id"
                                :label="item.value"
                                :value="item.id">
                        </el-option>
                    </el-select>
                    <el-select v-model="editForm.qu " @change="choseBlock" placeholder="请选择县区">
                        <el-option
                                v-for="item in qu1"
                                :key="item.id"
                                :label="item.value"
                                :value="item.id">
                        </el-option>
                    </el-select>
            </el-form-item>
            <el-form-item label="入职日期">
                <el-date-picker type="date" value-format="yyyy-MM-dd"
                                placeholder="选择日期" v-model="editForm.RUZHITIME"></el-date-picker>
            </el-form-item>
            <el-form-item label="部门">
                <template>
                    <el-select v-model="editForm.DEPTID" placeholder="请选择">
                        <el-option
                                v-for="item in option"
                                :key="item.DEPTID"
                                :label="item.DNAME"
                                :value="item.DEPTID">
                        </el-option>
                    </el-select>
                </template>
            </el-form-item>
            <el-form-item label="状态">
                <template>
                    <el-select v-model="editForm.STATE" placeholder="请选择">
                        <el-option
                                v-for="item in options"
                                :key="item.EID"
                                :label="item.STATES"
                                :value="item.EID">
                        </el-option>
                    </el-select>
                </template>
            </el-form-item>
            <el-form-item label="奖金">
                <el-input-number  v-model="editForm.COMM" :min="0" :max="2000"></el-input-number>
            </el-form-item>
            <el-form-item label="薪水">
                <el-input-number v-model="editForm.SAL" :min="0" :max="20000"></el-input-number>
            </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click.native="editFormVisible=false">取消</el-button>
            <el-button type="primary" @click.native="editSubmit" :loading="editLoading">提交</el-button>
        </div>
    </el-dialog>

</div>

<script type="text/javascript">
    var app = new Vue({
        el: '#app',
        data: {
            message: '员工列表'
        }
    });

    var tableView = new Vue({
        el: '#tableView',
        data:{
            mapJson: '../json/map.json',
            province:[],
            sheng: '',
            shi: '',
            shi1: [],
            qu: '',
            qu1: [],
            city: '',
            block: '',
            deptId: '',
                State: '',
                //类型select
                option: [],
                options: [],
                //列表数据
                tableData: [],
                //显示加载中样式
                loading: false,
            //编辑界面数据
            editForm: {
                ID: 0,
                EMPNO: '',
                ENAME: '',
                IDCARD: '',
                PHONE: '',
                ADDRESS: '',
                sheng: '',
                shi: '',
                qu: '',
                RUZHITIME: '',
                STATE: 0,
                DEPTID: 0,
                COMM: 0,
                SAL: 0
            },
                //搜索表单
                searchForm: {
                    id: '',
                    name: '',
                    deptId: '',
                    State: ''
            },
            //多选值
            multipleSelection: [],
                //当前页
                currentPage: 1,
                //分页大小
                pageSize: 10,
                //总记录数
                total: 800,
                //删除的弹出框
                deleteVisible: false,
                //编辑界面是否显示
                editFormVisible: false,
                editLoading: false,
                goUrl: '',
                editFormRules: {
                //表单验证
                EMPNO: [
                    {required: true, message: '请输入工号', trigger: 'blur'},
                    {pattern: /^EMP\d{4}$/, message: '请输入正确的员工号，前三位为EMP,后四位为数字'}
                ],
                    ENAME: [
                    {required: true, message: '请输入姓名', trigger: 'blur'},
                    {pattern: /^([\u4e00-\u9fa5]){2,8}$/, message: '请输入两到八个汉字'}
                ],
                    IDCARD: [
                    {required: true, message: '请输入身份证号', trigger: 'blur'},
                    {
                        pattern: /^\d{6}(19|20)\d{2}(0[1-9]|1[0-2])(0[1-9]|[1-2]\d|3[0-1])\d{3}(\d|X)$/,
                        message: '请输入正确的身份证号'
                    }
                ],
                    PHONE: [
                    {required: true, message: '请输入手机号码', trigger: 'blur'},
                    {pattern: /^1[3|4|5|7|8][0-9]\d{8}$/, message: '请输入正确的手机号'}
                ],
                    ADDRESS: [
                    {required: true, message: '请输入地址', trigger: 'blur'},
                    {pattern: /^[A-Za-z0-9\u4e00-\u9fa5]+$/, message: '请输入正确的地址 '}
                ],
            }
            },
            created: function () {
                //在 then的内部不能使用Vue的实例化的this, 因为在内部 this 没有被绑定。
              this.getCityData();
                var self = this;
               axios.post('/emp/page', {
                    'pageNo': this.currentPage,
                    'pageSize': this.pageSize
                }).then(function (response) {

                    self.total = response.data.total;
                    self.tableData = response.data.pageData;
                });

                axios.post('/emp/list').then(function (response) {
                    self.options = response.data;
                });
                axios.post('/dept/list').then(function (response) {
                    self.option = response.data;
                })
            },
            methods: {
                //刷新
                toFlush: function () {
                    this.searchForm = {
                        id: '',
                        name: '',
                        deptId: '',
                        State: ''
                    }
                    this.loadingData();
                },
                getCityData: function () {
                    var that = this;
                    axios.get(this.mapJson).then(function (response) {
                        if (reponse.status == 200) {
                            var data = reponse.data
                            that.province = []
                            that.city = []
                            that.block = []
                            //省市区数据分类
                            for (var item in data) {
                                if (item.match(/0000$/)) {//省级
                                    that.province.push({id: item, value: data[item], children: []})

                                } else if (item.match(/00$/)) {//市级
                                    that.city.push({id: item, value: data[item], children: []})
                                } else {//县级
                                    that.block.push({id: item, value: data[item]})
                                }
                            }
                            //市级分类
                            for (var index in that.province) {
                                for (var index1 in that.city) {
                                    if (that.province[index].id.slice(0, 2) === that.city[index1].id.slice(0, 2)) {
                                        that.province[index].children.push(that.city[index1])
                                    }
                                }
                            }
                            //区级分类
                            for (var item1 in that.city) {
                                for (var item2 in that.block) {
                                    if (that.block[item2].id.slice(0, 4) === that.city[item1].id.slice(0, 4)) {
                                        that.city[item1].children.push(that.block[item2])
                                    }
                                }
                            }
                        }
                        else {
                            console.log(response.status)
                        }
                    }).catch(function (error) {
                        console.log(typeof +error)
                    })
                },
                //选省
                choseProvince: function (e) {

                    for (var index2 in this.province) {
                        if (e===this.province[index2].id){
                            this.shi1 = this.province[index2].children
                            this.shi = this.province[index2].children[0].value
                            this.qu1 = this.province[index2].children[0].children
                            this.qu = this.province[index2].children[0].children[0].value
                            this.E = this.qu1[0].id

                        }

//                                this.editForm.sheng = "";
//                                this.editForm.sheng1 = this.province[index2].value;


                        }
                    },
                //选市
                choseCity: function (e) {
                    for (var index3 in this.city) {
                        if (e===this.city[index3].id){
                            this.qu1 = this.city[index3].children
                            this.qu = this.city[index3].children[0].value
                            this.E = this.qu1[0].id
                        }
//                                this.editForm.shi1 = ""
//                                this.editForm.shi1 = this.city[index3].value;
                            // console.log(this.E)
                        }
                    },
                //选县
                choseBlock: function (e) {
                    this.E = e;
                    // this.dataForm.addrA+=this.block[e].value;
                    // console.log(this.E)
//                    for (var index4 in this.block) {
//                                this.editForm.qu1 = ""
//                                this.editForm.qu1 = this.block[index4].value;
//                                this.address = this.editForm.sheng1 + this.editForm.shi1 + this.editForm.qu1

                        },
                //表格重新加载数据
                loadingData: function () {
                    var _self = this;
                    _self.loading = true;
                    var searchForm = {
                        'pageNo': this.currentPage,
                        'pageSize': this.pageSize,
                        'empNo': this.searchForm.id,
                        'ename': this.searchForm.name,
                        'deptid': this.searchForm.deptId,
                        'state': this.searchForm.State
                    };
                    axios.post('/emp/page', searchForm).then(function (response) {
                        _self.total = response.data.total;
                        _self.tableData = response.data.pageData;
                    });

                    console.log(_self.currentPage);
                    setTimeout(function () {
                        console.info("加载数据成功");
                        _self.loading = false;
                    }, 300);
                },
                //表格编辑事件
                editClick: function (row) {
                    this.goUrl = "/emp/update";
                    this.editFormVisible = true;
                    this.editForm = Object.assign({}, row);
                },
                //表格删除事件
                deleteClick: function (row) {
                    var _self = this;
                    this.$confirm('确认删除' + row.ID + '吗?', '提示', {
                        type: 'warning'
                    }).then(function () {
                        var url = "/emp/delete?id=" + row.ID;
                        axios.get(url).then(function (response) {
                            if (response.data > 0) {
                                _self.$message({
                                    message: row.ID + '删除成功',
                                    type: 'success',

                                });
                                _self.loadingData();//重新加载数据
                            } else {
                                _self.$message({
                                    message: row.ID + '删除失败',
                                    type: 'error'
                                });

                            }
                        });
                    }).catch(function (e) {
                        if (e != "cancel")
                            console.log("出现错误：" + e);
                    });
                },
                //新建事件
                addClick:function () {
                    this.goUrl = "/emp/add";
                    var _self = this;
                    //清空原有数据
                    this.editForm = {
                        EMPNO: '',
                        ENAME: '',
                        IDCARD: '',
                        PHONE: '',
                        ADDRESS: '',
                        RUZHITIME: '',
                        STATE: '',
                        DEPTID: '',
                        COMM: 0,
                        SAL: 0
                    }
                        //显示隐藏form表单
                    this.editFormVisible = true;

                    //_self.loadingData();//重新加载数据
                },


                //表格查询事件
                searchClick: function () {
                    var self = this;
                    self.loadingData();//重新加载数据
                },
                //表格勾选事件
                selectionChange: function (val) {
                    for (var i = 0; i < val.length; i++) {
                        var row = val[i];
                    }
                    this.multipleSelection = val;
                    console.info(val);
                },
                //删除所选，批量删除
                removeSelection: function () {
                    var _self = this;
                    var multipleSelection = this.multipleSelection;
                    if (multipleSelection.length < 1) {
                        _self.$message({
                            message: '请至少选中一条记录',
                            type: 'error'
                        });
                        return;
                    }
                    var ids = "";
                    for (var i = 0; i < multipleSelection.length; i++) {
                        var row = multipleSelection[i];
                        ids += row.ID + ","
                    }
                    this.$confirm('确认删除' + ids + '吗?', '提示', {
                        type: 'warning'
                    }).then(function () {
                        var url = "/emp/batchDel/" + ids;
                        axios.get(url).then(function (response) {
                            //alert(response.data);
                            var temp = "";
                            if (response.data > 0) {
                                temp = "删除成功";
                            } else {
                                temp = "删除失败，不可删除在职员工";
                            }
                            _self.$message({
                                message: ids + temp,
                                type: 'success'
                            });
                            _self.loadingData();//重新加载数据
                        });

                    }).catch(function (e) {
                        if (e != "cancel")
                            console.log("出现错误：" + e);
                    });
                },
                //分页大小修改事件
                pageSizeChange: function (val) {
                    console.log('每页 ' + val + ' 条');
                    this.pageSize = val;
                    var _self = this;
                    _self.loadingData();//重新加载数据
                },
                //当前页修改事件
                currentPageChange: function (val) {
                    this.currentPage = val;
                    console.log('当前页: ' + val);
                    var _self = this;
                    _self.loadingData();//重新加载数据
                },
                //保存点击事件
                editSubmit: function () {
                    var _self = this;
                    _self.loading = true;
                    var formData = this.editForm;
                    //alert(formData);
                    var goUrl = this.goUrl;
                    axios.post(goUrl, formData).then(function (response) {
                        if (response.data > 0) {
                            _self.editFormVisible = false;
                        } else if (response.data.msg != null && response.data.msg != '') {
                            _self.$message({
                                message: response.data.msg,
                                type: 'error'
                            });
                        }
                        else {
                            _self.$message({
                                message: '操作失败',
                                type: 'error'
                            });
                        }
                        _self.editFormVisible = false;
                        _self.loadingData();//重新加载数据
                    })
                    console.info(this.editForm);
                }
            }
        })
</script>
</body>
</html>